<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <title>PurpleScreen</title>
    <style>
      body{
        margin: 0;
        padding: 0;
        background-color: black;
        overflow: hidden;
      }
      button {
        border: 0;
        background-color: #116696;
        cursor: pointer;
      }
      #container {
        display: grid;
        height: 100vh;
        grid-gap: 5px;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        grid-auto-rows: auto 200px 30px;
      }
      #buttons {
        display: grid;
        height: 30px;
        grid-gap: 0 5px;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        position: absolute;
        padding-top: 1px;
        bottom: -30px;
        width: 100vw;
      }
      #buttons:hover {
        bottom: 0;
      }
      .purpleScreen {
          height: 100vh;
          width: 100vw;
          display:flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          background-color: #9146ff;
          font-family: "Comic Sans MS";
          color: #6441a5;
      }
      .underline {
          text-decoration: underline;
      }
      #helloworld {
          display: none;
      }
      h1{
          font-size: 72px;
      }
    </style>

  </head>
  <body id="body">
    <div id="helloworld">
      <div class='purpleScreen'>
        <h1>Purple Screen</h1>
        Add Twitch channels to url hash, separated by comma (,)
      </div>
    </div>
    <div id="streams">
      <div id="container"></div>
      <div id="buttons"></div>
    </div>

    <script>
      const dev = 0; // 0 = 'prod', 1 = no https redirect (localhost), 2 = 1 + no twitch loading
      let activeId = "";
      let fullscreen = false;

      if (location.protocol !== 'https:' && dev < 1) {
        location.replace(`https:${location.href.substring(location.protocol.length)}`);
      }

      let channels = [];

      const activateChannel = (activateId) => {
        if(activeId === activateId) {
          return;
        } else {
          activeId = activateId;
          channels.forEach(({id, player, defCol}) => {
            const div = document.getElementById(id);
            if(activateId === id){
              div.style.gridColumn = "1 / -1";
              div.style.gridRow = "1";
              player.setMuted(false);
            } else {
              div.style.gridColumn = defCol;
              div.style.gridRow = "2";
              player.setMuted(true);
            }
          })
        }
      }

      const setup = () => {
        if(!document.location.hash) {
          document.getElementById("streams").style.display="none";
          document.getElementById("helloworld").style.display="block";
          return;
        }
        channels = document.location.hash.slice(1).split(",").map(c => ({id: c}));

        const container = document.getElementById("container");
        const buttons = document.getElementById("buttons");
        const templCols =  `auto ${"356px ".repeat(channels.length)}auto`;
        container.style.gridTemplateColumns = templCols;
        buttons.style.gridTemplateColumns = templCols;

        channels = channels.map(({id}, i) => {
          const el = document.createElement("div");
          const defCol = `${i+2}`
          el.id = id;
          el.style.gridRow = "2";
          el.style.gridColumn = defCol;
          el.style.backgroundColor = "#9146ff";
          container.appendChild(el);

          const btn = document.createElement("button");
          btn.innerHTML = `<span class="underline">${i + 1}</span> ${id}`
          btn.style.gridColumn = defCol;
          btn.onclick = () => activateChannel(id);
          buttons.appendChild(btn);

          let embed;
          if(dev < 2) {
            embed = new Twitch.Embed(id, {
              width: "100%",
              height: "100%",
              channel: id,
              muted: true,
              autoplay: true,
              layout: "video",
            });
            embed.addEventListener(Twitch.Embed.VIDEO_PLAY, () => {
              player.setVolume(1);
              player.setQuality("chunked");
            });
          } else {
            embed = {getPlayer: () => ({setVolume: ()=>{}, setMuted: () => {}})}
          }

          const player = embed.getPlayer();

          return {id, player, el, defCol}
        })
      }

      const keyPressed = (e) => {
        if(!isNaN(e.key)){
          const channel = channels[e.key - 1];
          if(channel){
            activateChannel(channel.id)
          }
        } else if (e.key === "f") {
          const container = document.getElementById("container");
          if(fullscreen) {
            container.style.gridAutoRows = "auto 200px 30px";
            fullscreen = false;
          } else {
            container.style.gridAutoRows = "100vh 200px 30px";
            fullscreen = true;
          }
        }
      }
      document.addEventListener('keydown', keyPressed);

      window.onhashchange = () => location.reload();
      setup();
    </script>
  </body>
</html>
